(function(a){function X(c){if(!c||!c.denied||!a.isFunction(c.denied))return M(this,d.InvalidArguments,"wrong arguments ()");l(b.api,"userauthorized",function e(a){a?window.userAuthHandler():c.denied(),m(b.api,"userauthorized",e)}),b.api.showUserAuthorization()}function W(){var a=o();if(!a.capabilities.delayedUserAuth){M(this,d.OperationNotSupported,"Check cwic('about').capabilities.delayedUserAuth");return"Unknown"}return b.api.getUserAuthStatus()}function V(){j(!0,"setCaptureDevice",arguments);var a=arguments[0];if(typeof a!="string"||a.length===0)return M(this,d.InvalidArguments,"wrong arguments (setCaptureDevice)",arguments);return b.api.setCaptureDevice({clientCaptureID:a})}function U(){j(!0,"setPlayoutDevice",arguments);var a=arguments[0];if(typeof a!="string"||a.length===0)return M(this,d.InvalidArguments,"wrong arguments (setPlayoutDevice)",arguments);return b.api.setPlayoutDevice({clientPlayoutID:a})}function T(){j(!0,"setRecordingDevice",arguments);var a=arguments[0];if(typeof a!="string"||a.length===0)return M(this,d.InvalidArguments,"wrong arguments (setRecordingDevice)",arguments);return b.api.setRecordingDevice({clientRecordingID:a})}function S(){var a=b.api.getMultimediaDevices();j(!0,"getMultimediaDevices returned:",a);return a}function R(){j(!0,"getInstanceId");return b.api.instanceId}function Q(){j(!0,"sendDTMF");var a=this,c=null,e=a.data("cwic"),f=e?e.id:null;arguments.length>0&&(c=typeof arguments[0]=="string"?arguments[0]:null,arguments.length>1&&(typeof arguments[1]=="object"?(e=arguments[1],f=e.id):typeof arguments[1]=="string"&&(f=arguments[1])));if(typeof c!="string"||!f)return M(a,d.InvalidArguments,"wrong arguments (sendDTMF)",arguments);var g=b.api.sendDTMF({callId:f,digit:c});if(g.error)return M(a,d.NativePluginError,g.error);return a}function P(){j(!0,"updateConversation",arguments);var c=this;if(c.length===0)return c;var e=arguments[0],g=null,h=null;typeof arguments[1]=="object"?(g=arguments[1],h=g.id):typeof arguments[1]=="undefined"?(g=c.data("cwic"),typeof g=="object"&&(h=g.id)):(h=arguments[1],g=a(".cwic-conversation-"+h).data("cwic")||c.data("cwic"));if(!h||!g)return M(c,d.InvalidArguments,"cannot update conversation: undefined or empty conversation id");var i={};if(typeof e=="string"){if(e.match(/^hold$/i))i=b.api.hold({callId:h});else if(e.match(/^resume$/i))i=b.api.resume({callId:h});else if(e.match(/^mute$/i))i=b.api.mute({callId:h});else if(e.match(/^unmute$/i))i=b.api.unmute({callId:h});else if(e.match(/^muteAudio$/i))i=b.api.mute({callId:h,muteAudio:!0});else if(e.match(/^muteVideo$/i))i=b.api.mute({callId:h,muteVideo:!0});else if(e.match(/^unmuteAudio$/i))i=b.api.unmute({callId:h,unmuteAudio:!0});else if(e.match(/^unmuteVideo$/i))i=b.api.unmute({callId:h,unmuteVideo:!0});else return M(c,d.InvalidArguments,"wrong arguments (update conversation) - "+e,arguments);if(i.error)return M(c,f(i.error),i.error)}else{if(typeof e!="object")return M(c,d.InvalidArguments,"wrong arguments (update conversation)",arguments);var k=!1;if(e.transferCall){k=!0,i=b.api.transferCall({callId:h,transferCallId:e.transferCall});if(i.error)return M(c,f(i.error,"NativePluginError"),"transferCall",i)}if(e.joinCall){k=!0,i=b.api.joinCalls({joinCallId:h,callId:e.joinCall});if(i.error)return M(c,f(i.error,"NativePluginError"),"joinCall",i)}if(e.videoDirection){k=!0,i=b.api.setVideoDirection({callId:h,videoDirection:e.videoDirection});if(i.error)return M(c,d.NativePluginError,"videoDirection",i.error)}e.addRemoteVideoWindow&&(k=!0,s.add({callId:h,plugin:e.addRemoteVideoWindow,window:e.window})),e.removeRemoteVideoWindow&&(k=!0,s.remove({callId:h,plugin:e.addRemoteVideoWindow,window:e.window}));if(!k)return M(c,d.InvalidArguments,"wrong arguments (update conversation)",arguments)}return c}function O(){j(!0,"endConversation",arguments);var c=this;if(c.length===0)return c;var e=null,f=null,g=null;if(arguments.length===0){f=c.data("cwic");if(!f)return M(c,"cannot end conversation: no conversation exists for this element");g=f.id}else arguments.length===1?(e=typeof arguments[0]=="boolean"?arguments[0]:null,f=typeof arguments[0]=="object"?arguments[0]:c.data("cwic"),g=typeof arguments[0]=="string"?arguments[0]:f.id):arguments.length===2&&(e=typeof arguments[0]=="boolean"?arguments[0]:null,f=typeof arguments[1]=="object"?arguments[1]:c.data("cwic"),g=typeof arguments[1]=="string"?arguments[1]:f.id);if(!g)return M(c,d.InvalidArguments,"cannot end conversation: undefined or empty conversation id");if(e){f=f||a(".cwic-conversation-"+g).data("cwic");if(!f)return M(c,"cannot iDivert - undefined conversation");if(!f.capabilities||!f.capabilities.canImmediateDivert)return M(c,d.MissingCapability,"cannot iDivert - missing capability",{conversation:f});j(!0,"iDivert conversation",f),b.api.iDivert({callId:g})}else j(!0,"end conversation",f),b.api.endCall({callId:g});return c}function N(){j(!0,"startConversation",arguments);var c=this,e=arguments[0]||c.data("cwic")||{},g,h;if(c.length===0)return M(c,e.error,d.InvalidArguments,"cannot start conversation with empty selection");var i=c;typeof e.container=="string"?i=a(e.container):typeof e.container=="object"&&(i=e.container),i=i.first();if(typeof e.id!="undefined"){i.addClass("cwic-data cwic-conversation cwic-conversation-"+e.id).data("cwic",e),arguments.length>=1?(h=e.videoDirection,e.remoteVideoWindow&&(s.add({callId:e.id,plugin:e.remoteVideoWindow}),e.remoteVideoWindow.windowhandle&&(g=e.remoteVideoWindow.windowhandle))):h="";var k={callId:e.id,videoDirection:h};g&&(k.windowhandle=g),b.api.answer(k)}else{var l=e.participant||{};typeof l=="string"&&(l={recipient:l});if(typeof l.recipient=="undefined")return M(c,e.error,d.InvalidArguments,"cannot start conversation: undefined or empty recipient");i.addClass("cwic-data cwic-conversation cwic-conversation-outgoing").data("cwic",{participant:l}),i.is(":hidden")&&j(!0,"startConversation - warning: container is hidden");var m={recipient:l.recipient,videoDirection:e.videoDirection};e.remoteVideoWindow&&e.remoteVideoWindow.windowhandle&&(m.windowhandle=e.remoteVideoWindow.windowhandle);var n=b.api.originate(m);n.error&&(j(!0,"originate result",n),M(c,f(n.error),n.error,"cannot start conversation")),n.callId&&n.callId>=1&&e.remoteVideoWindow&&(e.window=e.window||window,s.add({callId:n.callId,plugin:e.remoteVideoWindow,window:e.window}))}return c}function M(){var b=arguments[0],c=null,e=a.extend({details:[]},d.Unknown);for(var f=1;f<arguments.length;f++){var g=arguments[f];a.isFunction(g)?c=g:typeof g=="string"?e.details.push(g):typeof g=="object"&&a.extend(e,g)}j(e.message,e);if(c)try{c(e)}catch(h){j("Exception occurred in application error callback",h),typeof console!="undefined"&&console.trace&&console.trace()}else{var i=a.Event("error.cwic");a.extend(i,e),b.trigger(i)}return b}function L(b,c,d){var e=c.callId,f=c.callState,g=c.participants&&c.participants.length>0?c.participants[0]:{},h=g.directoryNumber&&g.directoryNumber!==""?g.directoryNumber:g.number;g=a.extend({},g,{recipient:h});var i=a(".cwic-conversation-"+e);i.length===0&&(i=a(".cwic-conversation-outgoing"));var k=i.data("cwic")||{};j(!0,"conversation id="+e+" state="+c.callState||k.state,c),c=a.extend({},k,c,{id:e,state:f||k.state,media:"audio",participant:a.extend(k.participant,g)});if((c.state!=="Proceed"&&c.state!=="Created"||c.callType!=="Incoming")&&c.state!=="Ringin"||i.length!==0){if(c.state==="OnHook"&&!c.capabilities.canOriginateCall||!c.exists){s.deleteCall({callId:e});if(i.length===0){j("warning: no container for ended conversation "+e),b.trigger("conversationEnd.cwic",[c]);return}i.removeData("cwic").removeClass("cwic-data cwic-conversation cwic-conversation-"+c.id).trigger("conversationEnd.cwic",[c]);return}if(c.state==="OffHook"||c.state==="Connected"){typeof c.connect=="undefined"&&c.state==="Connected"&&(i.length===0&&(i=a("<div>").addClass("cwic-conversation cwic-conversation-"+e)),a.extend(c,{connect:new Date}),i.data("cwic",c));if(typeof c.start=="undefined"){i.length===0&&(i=a("<div>")),a.extend(c,{start:new Date}),i.data("cwic",c),i.removeClass("cwic-conversation-outgoing").addClass("cwic-conversation cwic-conversation-"+e).data("cwic",c),b.trigger("conversationStart.cwic",[c,i]);return}}if(i.length===0){i=a("<div>").data("cwic",c).addClass("cwic-conversation cwic-conversation-"+e);if(c.exists){b.trigger("conversationStart.cwic",[c,i]);return}b.trigger("conversationUpdate.cwic",[c,i]);return}i.data("cwic",c),i.trigger("conversationUpdate.cwic",[c,i])}else i=a("<div>").addClass("cwic-data cwic-conversation cwic-conversation-"+e).data("cwic",c),b.trigger("conversationIncoming.cwic",[c,i])}function K(){a(".cwic-data").removeData("cwic")}function J(){j(!0,"unregisterPhone",arguments);var a=this;typeof arguments[0]=="object"&&typeof arguments[0].forceLogout!="undefined"&&arguments[0].forceLogout&&(b.api.logout(),g={devices:{}}),K();if(typeof arguments[0]=="object"&&typeof arguments[0].complete!="undefined"){var c=arguments[0].complete;h.unregisterCb=function(){try{c()}catch(a){j("Exception occurred in application unregister complete callback",a),typeof console!="undefined"&&console.trace&&console.trace()}h.unregisterCb=null}}return a}function I(e){j(!0,"registerPhone",arguments);var i=this,k=o();!k.capabilities.multireg&&typeof e.forceRegistration!="undefined"&&j("Warning: Attempting to use forceRegistration parameter on unsupported platform. Parameter will be ignored."),h.registeringPhone=!0,g={user:e.user,mode:e.mode||"SoftPhone",devices:{},forceRegistration:e.forceRegistration||!1,authenticate:typeof e.authenticate=="boolean"?e.authenticate:!1};var l=e.password,m="",n=a.isFunction(e.devicesAvailable)?e.devicesAvailable:null;h.successCb=a.isFunction(e.success)?e.success:null,h.errorCb=a.isFunction(e.error)?e.error:null,h.CUCM=e.cucm,g.useCcmcip=!1,typeof e.useCcmcip!="undefined"?g.useCcmcip=e.useCcmcip:g.useCcmcip=e.useCcmcip;if(!b)return M(i,h.errorCb,d.PluginNotAvailable,"Plug-in is not available or has not been initialized",{registration:g});if(typeof l=="string")l={cipher:"cucm",encrypted:b.api.encryptCucmPassword(e.password)},g.authenticate&&(m=e.password);else if(typeof l!="object"||l.cipher!=="cucm"&&l.cipher!=="base64")return M(i,h.errorCb,d.InvalidArguments,"invalid password (type "+typeof l+")",{registration:g});var r=e.device||b.api.PreferredDevice;typeof r=="object"&&(r=r.name?r.name:"");var s=e.line||b.api.PreferredLine;typeof s=="object"&&(s=s.directoryNumber?s.directoryNumber:"");var t=[],w=[],x=[];a.each(a.makeArray(e.cucm),function(b,c){if(typeof c=="string"){var d=c.split(" ").pop();t.push(d),w.push(d),x.push(d)}else if(typeof c=="object"){var e=[],f=!1;a.isArray(c.tftp)&&(t=t.concat(c.tftp),e=c.tftp,f=!0),a.isArray(c.ccmcip)?(w=w.concat(c.ccmcip),f=!0):w=w.concat(e),a.isArray(c.cti)?(x=x.concat(c.cti),f=!0):x=x.concat(e),f||(j("registerPhone: no ccmcip/tftp/cti properties for cucm element"),j(!0,c))}else j("registerPhone: ignoring cucm argument of type "+typeof c)}),j("registerPhone: "+t.length+" cucm TFTP address(es)"),j(!0,t),j("registerPhone: "+w.length+" cucm CCMCIP address(es)"),j(!0,w),j("registerPhone: "+x.length+" cucm CTI address(es)"),j(!0,x),j("registerPhone of user="+g.user+" (authenticate="+g.authenticate+') in mode="'+g.mode+'"');if(!g.user||g.user==="")return M(i,h.errorCb,d.InvalidArguments,"Missing user name",{registration:g});if(!a.isArray(t)||t.length<1)return M(i,h.errorCb,d.NoCallManagerConfigured,"Missing CUCM address",{registration:g});if(!g.mode.match(/^(SoftPhone|DeskPhone)$/))return M(i,h.errorCb,d.InvalidArguments,'Invalid phone mode "'+g.mode+'"',{registration:g});b.api.TftpAddressList=t,b.api.CtiAddressList=x,b.api.CcmcipAddressList=w;var y=b.api.connectionStatus;y==="eReady"&&v(i,y),h.password=l;if(!g.authenticate||g.mode==="DeskPhone"){g.mode==="DeskPhone"&&(!r||!r.match(/^\s*SEP/i))&&(r="",s="");if(y!=="eReady"){var z="Did nothing";l.encrypted?(h.authenticatedCallback=function(){var a=u(y);if(n)try{n(a,g.mode,function(a,c,d){var e=b.api.connect({phoneMode:a,deviceName:c,lineDN:d,forceRegistration:g.forceRegistration});if(e.error){var j=f(e.error);return M(i,h.errorCb,j,e.error,{registration:g})}})}catch(c){j("Exception occurred in application devicesAvailable callback",c),typeof console!="undefined"&&console.trace&&console.trace()}else{var d=[];if(r)j(!0,"connect will attempt using preferredDevice: "+r),d.name=r;else{for(var e=0;e<a.length;e++){if(g.mode==="SoftPhone"&&a[e].isSoftPhone&&a[e].modelDescription.match(/^\s*Cisco\s+Unified\s+Client\s+Services\s+Framework\s*$/i)){d=a[e];break}if(g.mode==="DeskPhone"&&a[e].isDeskPhone){d=a[e];break}}j(!0,"connect will use discovered device: ",d)}var k=b.api.connect({phoneMode:g.mode,deviceName:d.name,lineDN:"",forceRegistration:g.forceRegistration});if(k.error){var l=f(k.error);return M(i,h.errorCb,l,k.error,{registration:g})}}h.authenticatedCallback=null,delete h.authenticatedCallback},z=b.api.authenticate({username:g.user,password:l.encrypted,useCcmcip:c.useCcmcip})):z=b.api.connect({phoneMode:g.mode,deviceName:p({username:g.user}),lineDN:"",forceRegistration:g.forceRegistration});if(z.error){var A=f(z.error);return M(i,h.errorCb,A,z.error,{registration:g})}}}else{var B=[].concat(w),C=function(){var e=B.shift();typeof e=="undefined"?M(i,h.errorCb,d.NoCucmFound,"cannot register phone",{registration:g}):(j(!0,'authenticate against CUCM "'+e+'"'),a.ajax({url:c.node+"/phoneconfig/devices"+"?ccmcip="+e,beforeSend:function(a){var b="Basic "+q(g.user+":"+m);a.setRequestHeader("Authorization",b)},error:function(a,b,c){j(!0,'CCMCIP failure with CUCM "'+e+'" : '+b,c),C()},success:function(c){g.cucm={ccmcip:[e],tftp:[e]};var f=null,k=null;a.each(c,function(b,c){j(!0,"device="+c.name+' model="'+c.model+'"');if(typeof c.name!="undefined"&&typeof c.model!="undefined"){if(c.model.match(/^\s*Cisco\s+Unified\s+Client\s+Services\s+Framework\s*$/i)){c.csf=!0;if(g.mode==="SoftPhone"){c.name===r&&(f=c);if(c.name.match(/^ECP/i)||!k)k=c}}c.name.match(/^\s*SEP/i)&&(c.deskphone=!0,g.mode==="DeskPhone"&&(c.name===r&&(f=c),k||(k=c))),g.devices[a.trim(c.name)]=a.extend({},g.devices[a.trim(c.name)],c)}}),j(!0,"default device is "+(k===null?k:k.name));if(n){try{f=n(c,g.mode)}catch(l){j("Exception occurred in application devicesAvailable callback",l),typeof console!="undefined"&&console.trace&&console.trace()}if(f===!1){j("registration interrupted");return}}f===null&&(f=k);if(!f)return M(i,h.errorCb,d.NoDevicesFound,"no device found",{registration:g});if(g.mode!=="SoftPhone"&&f.csf||g.mode!=="DeskPhone"&&f.deskphone)return M(i,h.errorCb,d.NoDevicesFound,"cannot register in "+g.mode+' mode with device "'+f.name+'"',{registration:g});j('selected device is "'+f.name+'"'),b.api.PreferredDevice=f.name,g.device=f,b.api.connect({phoneMode:g.mode,deviceName:b.api.PreferredDevice,lineDN:"",forceRegistration:g.forceRegistration})}}))};C()}return i}function H(c){var d,e=this;h.successCb=a.isFunction(c.success)?c.success:null,h.errorCb=a.isFunction(c.error)?c.error:null,h.switchingMode=!0;var i=c.mode||"SoftPhone",k=c.device||(c.mode==="SoftPhone"?p({username:g.user}):""),l=c.line||"",m=c.forceRegistration||!1;j("About to call switchMode with mode: "+i+", deviceName: "+k+", lineDn: "+l),d=b.api.switchMode({phoneMode:i,deviceName:k,lineDN:l,forceRegistration:m});if(d.error)c.error&&a.isFunction(c.error)&&M(e,c.error,f(d),{message:d});else if(c.progress&&a.isFunction(c.progress))try{c.progress({message:d})}catch(n){j("Exception occurred in application switchPhoneMode progress callback",n),typeof console!="undefined"&&console.trace&&console.trace()}return this}function G(a){l(b.api,"callstatechange",function(b){L(a,b,"state")}),l(b.api,"videoresolutionchange",function(b){j(!0,"video resolution change detected for call "+b.callId+". Height: "+b.height+", width: "+b.width,b),L(a,{callId:b.callId,videoResolution:{width:b.width,height:b.height}},"render")})}function F(a){l(b.api,"connectionstatuschange",function(b){v(a,b)}),l(b.api,"multimediadevicechange",function(){E(a)}),l(b.api,"connectionfailure",function(b){var c=f(b,"LoginError");j(!0,b,c),M(a,h.errorCb,c,b,{registration:g})}),l(b.api,"authenticationresult",function(b){D(a,b)}),l(b.api,"authenticationstatuschange",function(a){j(!0,"authenticationStatus "+a)}),l(b.api,"callcontrolmodechange",function(b){b.phoneMode!=="NoMode"&&(g.mode=b.phoneMode,v(a,"ePhoneModeChanged")),j(!0,"callcontrolmodechange. Mode: "+b.phoneMode+", deviceName: "+b.deviceName+", DN: "+b.lineDN)})}function E(b){j(!0,"mmDeviceChange");var c=a.Event("mmDeviceChange.cwic");b.trigger(c)}function D(a,b){j(!0,"authenticationResult "+b),b==="eNoError"?h.authenticatedCallback&&h.authenticatedCallback():(h.authenticatedCallback&&(h.authenticatedCallback=null,delete h.authenticatedCallback),M(a,h.errorCb,f(b,"LoginError"),b,{registration:g}))}function C(){j(!0,"shutdown",arguments),J(),a(document).unbind(".cwic"),K();try{b&&b.api&&typeof b.api.releaseInstance!="undefined"&&b.api.releaseInstance()}catch(c){}b=null}function B(a){var b=this;a.window=a.window||window,a.previewWindow&&r.remove({plugin:a.previewWindow,window:a.window});return b}function A(a){var b=this;a.window=a.window||window,a.previewWindow&&r.add({plugin:a.previewWindow,window:a.window});return b}function z(a){var c=this,d=!b||!b.api?undefined:b.api.supportsVideo;if(d){a=a||{},a.window=a.window||window;var e="application/x-cisco-cwc-videocall",f=a.onload||"_cwic_onVideoPluginLoaded",g=a.success,h=a.id||"_cwic_vw"+y;y++;var i=t.getWindowId({window:a.window});t.callbacks[i][h]={callback:g,wascalled:!1};var j='<object type="'+e+'" id="'+h+'"><param name="loadid" value="'+h+'"></param><param name="onload" value="'+f+'"></param></object>';jQuery(c).append(j)}return c}function x(e){j(!0,"init",arguments);var g=this;typeof e.errorMap!="undefined"&&a.each(e.errorMap,function(b,c){typeof c=="string"?d[b]=a.extend({},d[b],{message:c}):typeof c=="object"?d[b]=a.extend({},d[b],c):j("ignoring invalid custom error [key="+b+"]",c)}),a.extend(c,e),window.userAuthHandler=function(){w(g,!0)},window._cwic_onPluginLoaded=function(){var e;try{var h=document.getElementById("cwc-plugin");if(h)b={},b.api=h,b.version=b.api.version;else throw f("PluginNotAvailable");j("initialized plugin version "+b.version.plugin+" (ecc "+b.version.ecc+")"),a(window).unload(function(){C()});if(typeof b.api.showUserAuthorization=="undefined")return M(g,c.error,d.ReleaseMismatch,"Plug-in version "+b.version.plugin+" does not support user authorization");var i=o();a.isFunction(c.delayedUserAuth)&&i.capabilities.delayedUserAuth&&b.api.getUserAuthStatus()!=="UserAuthorized"?c.delayedUserAuth():(l(b.api,"userauthorized",function k(a){w(g,a),m(b.api,"userauthorized",k)}),b.api.showUserAuthorization());return}catch(n){typeof console!="undefined"&&console.trace&&console.trace(),b=null,e=a.extend({},d.PluginNotAvailable,n)}M(g,c.error,"Cannot Initialize Cisco Web Communicator",e)},a(document.body).ready(function(){if(b===null)try{if(navigator.userAgent.indexOf("Node")===-1){try{var d=new ActiveXObject("CiscoSystems.CWCVideoCall");d=null}catch(e){try{var h=new ActiveXObject("ActivexPlugin.WebPhonePlugin.1");h=null;throw f("ReleaseMismatch")}catch(i){var j=navigator.mimeTypes["application/x-ciscowebcommunicator"];if(typeof j=="undefined"){j=navigator.mimeTypes["application/x-ciscowebphone"];throw typeof j!="undefined"?f("ReleaseMismatch"):f("PluginNotAvailable")}}}a(document.body).append('<object id="cwc-plugin" width="1" height="1" type="application/x-ciscowebcommunicator"><param name="onload" value="_cwic_onPluginLoaded"></param></object>')}}catch(k){b=null,M(g,c.error,k)}});return g}function w(e,f){var g;try{if(f===!0){var h={},i=!1,k=b.api.connectionStatus;k==="eReady"&&(i=!0),v(e,k),F(e),G(e),j("setting media port splitting to "+c.mediaPortSplitting),b.api.MediaPortSplitting=c.mediaPortSplitting;var l=b.api.mode;if(a.isFunction(c.ready))try{c.ready(h,i,l)}catch(m){j("Exception occurred in application ready callback",m),typeof console!="undefined"&&console.trace&&console.trace()}if(i){var n=b.api.getCalls();for(var o=0;o<n.calls.length;o++)L(e,n.calls[o],"state")}return}g=d.NotUserAuthorized}catch(p){typeof console!="undefined"&&console.trace&&console.trace(),b=null,g=a.extend({},d.PluginNotAvailable,p)}M(e,c.error,"Cannot Initialize Cisco Web Communicator",g)}function v(c,d){j(!0,"providerState "+d);var e=a.Event("system.cwic");e.phone={status:d,ready:!1},u(d),e.phone.registration=g;if(d==="eReady"){if(h.registeringPhone||h.switchingMode){h.registeringPhone=!1,h.switchingMode=!1;if(h.successCb)try{h.successCb(a.extend({},g,{cucm:a.makeArray(h.CUCM),password:h.password,mode:b.api.mode,successfulCucm:{tftp:b.api.successfulTftpAddress,cti:b.api.successfulCtiAddress}}))}catch(f){j("Exception occurred in application success callback",f),typeof console!="undefined"&&console.trace&&console.trace()}else j("warning: no registerPhone success callback")}e.phone.ready=!0,c.trigger(e);var i=b.api.getCalls();for(var k=0;k<i.calls.length;k++)L(c,i.calls[k],"state")}else if(d==="ePhoneModeChanged"){if("SoftPhone"==b.api.mode||"DeskPhone"==b.api.mode)e.phone.ready=!0;c.trigger(e)}else d==="eIdle"?(h.unregisterCb&&h.unregisterCb(),c.trigger(e)):c.trigger(e)}function u(c){var d=b.api.getAvailableDevices(),e=d.devices;a.each(a.makeArray(e),function(b,c){if(c.name){var d=a.trim(c.name);g.devices[d]=a.extend({},g.devices[d],c)}});var f="";f!==""&&a.extend(g.device,{name:f}),c!="eIdle"&&(g.device=a.extend({},b.api.device),g.line=a.extend(g.line,b.api.line));return e}function q(b){if(a.isFunction(c.encodeBase64))try{return c.encodeBase64(b)}catch(d){j("Exception occurred in application encodeBase64 callback",d),typeof console!="undefined"&&console.trace&&console.trace()}if(a.isFunction(window.btoa))return window.btoa(b);j("error: cannot encode base64");return""}function p(b){if(!a.isFunction(c.predictDevice))return b.username?c.devicePrefix+b.username:"";try{return c.predictDevice(b)}catch(d){j("Exception occurred in application predictDevice callback",d),typeof console!="undefined"&&console.trace&&console.trace()}}function o(){j(!0,"about",arguments);var c={javascript:{version:"3.0.2.61092",system_release:"Cisco Unified Communications System Release 9.2 MR2"},jquery:{version:a.fn.jquery},plugin:b===null?null:{version:b.version},states:{system:!b||!b.api?"unknown":b.api.connectionStatus},device:!b||!b.api?{exists:!1,inService:!1,lines:{},model:-1,modelDescription:"",name:""}:b.api.device,capabilities:{video:!b||!b.api?undefined:b.api.supportsVideo,multireg:!b||!b.api?undefined:b.api.supportsVideo,delayedUserAuth:!b||!b.api?undefined:typeof b.api.getUserAuthStatus!="undefined"},upgrade:{}},d=c.javascript.version.match(/(\d+)\.(\d+)\.(\d+)\.(\d+)/);d&&(c.javascript.release=d[1],c.javascript.major=d[2],c.javascript.minor=d[3],c.javascript.revision=d[4]),c.plugin?(d=c.plugin.version.plugin.match(/(\d+)\.(\d+)\.(\d+)\.(\d+)/),d&&(c.plugin.release=d[1],c.plugin.major=d[2],c.plugin.minor=d[3],c.plugin.revision=d[4]),c.javascript.release>c.plugin.release?c.upgrade.plugin="mandatory":c.javascript.release<c.plugin.release?c.upgrade.javascript="mandatory":c.javascript.release==c.plugin.release&&(c.javascript.major>c.plugin.major?c.upgrade.plugin="mandatory":c.javascript.major<c.plugin.major?c.upgrade.javascript="recommended":c.javascript.major==c.plugin.major&&(c.javascript.minor>c.plugin.minor?c.upgrade.plugin="recommended":c.javascript.minor<c.plugin.minor&&(c.upgrade.javascript="recommended")))):c.upgrade.plugin="mandatory";return c}function j(){var b=typeof arguments[0]=="boolean"?arguments[0]:!1,d=typeof arguments[0]=="string"?arguments[0]:arguments[1],e=typeof arguments[1]=="object"?arguments[1]:arguments[2];if((!b||b&&c.verbose)&&a.isFunction(c.log))try{var f=new Date,g=f.getDate()+"/"+("0"+(f.getMonth()+1)).slice(-2)+"/"+f.getFullYear()+" "+("0"+f.getHours()).slice(-2)+":"+("0"+f.getMinutes()).slice(-2)+":"+("0"+f.getSeconds()).slice(-2)+"."+("00"+f.getMilliseconds()).slice(-3)+" ";c.log("[cwic] "+g+d,e)}catch(h){}}var b=null,c={encodeBase64:null,ready:null,useCcmcip:!0,devicePrefix:"ecp",verbose:!1,log:function(a,b){typeof console!="undefined"&&console.log&&(console.log(a),b&&console.log(b))},error:function(a){j("Error: ",a)},node:"",mediaPortSplitting:!1,delayedUserAuth:null},d={Unknown:{code:0,message:"Unknown error"},PluginNotAvailable:{code:1,message:"Plugin not available"},BrowserNotSupported:{code:2,message:"Browser not supported"},InvalidArguments:{code:3,message:"Invalid arguments"},InvalidState:{code:4,message:"Invalid State"},NativePluginError:{code:5,message:"Native plugin error"},OperationNotSupported:{code:6,message:"Operation not supported"},ReleaseMismatch:{code:7,message:"Release mismatch"},NoCallManagerConfigured:{code:10,message:"No CUCM found"},NoDevicesFound:{code:11,message:"No devices found"},NoCsfDevicesFound:{code:12,message:"No CSF device found"},PhoneConfigGenError:{code:13,message:"Phone configuration error"},SipProfileGenError:{code:14,message:"Sip profile error"},ConfigNotSet:{code:15,message:"Configuration not set"},TftpFetchError:{code:16,message:"TFTP fetch error"},TooManyPluginInstances:{code:18,message:"Too many plug-in instances - device registered in another browser"},AuthenticationFailure:{code:19,message:"Authentication failed"},LoginError:{code:20,message:"Login Error"},NoCredentialsConfigured:{code:21,message:"No credentials configured"},InvalidCredentials:{code:22,message:"Invalid credentials"},CallControlError:{code:30,message:"Call control error"},CreateCallError:{code:31,message:"Cannot create call"},VideoWindowError:{code:40,message:"Video window error"},NotUserAuthorized:{code:41,message:"User did not authorize access"},NoError:{code:999,message:"No error"}},e={Ok:"NoError",eNoError:"NoError",eInvalidCallId:"InvalidArguments",eCreateCallFailed:"CreateCallError",eNoActiveDevice:"PhoneConfigGenError",eTftpNotConfigured:"ConfigNotSet",eCallOperationFailed:"CallControlError",eLoggedInLock:"TooManyPluginInstances",eLogoutFailed:"LoginError",eCcmcipNotConfigured:"ConfigNotSet",eWindowAlreadyExists:"VideoWindowError",eInvalidState:"InvalidState",eCtiNotConfigured:"ConfigNotSet",eNoPhoneMode:"InvalidArgument",eNoWindowExists:"VideoWindowError",eInvalidArgument:"InvalidArguments",eUnknownFailure:"LoginError",eUnsupportedPhoneMode:"LoginError",eNoAuthServersConfigured:"NoCallManagerConfigured",eNoCredentialsConfigured:"NoCredentialsConfigured",eAuthCouldNotConnect:"LoginError",eAuthServerCertificateRejected:"LoginError",eCredentialsRejected:"InvalidCredentials",eAuthResponseEmpty:"LoginError",eAuthResponseInvalid:"LoginError",eNoTftpServersConfigured:"NoCallManagerConfigured",eNoDeviceNameConfigured:"LoginError",eLineMustNotBeConfigured:"LoginError",eNoLocalIpConfigured:"LoginError",eTftpCouldNotConnect:"TftpFetchError",eTftpFileNotFound:"TftpFetchError",eTftpFileEmpty:"TftpFetchError",eTftpFileInvalid:"TftpFetchError",eRequireAuthenticationString:"LoginError",eCapfEnrolmentFailed:"LoginError",eRequireSecureCachePath:"LoginError",eRequireSecurityLibrary:"LoginError",eStorageError:"LoginError",eSecurityLibraryError:"LoginError",eCapfEnrolmentRequired:"LoginError",eNoCtiServersConfigured:"LoginError",eDeviceNotInService:"LoginError",eNoServersConfigured:"NoCallManagerConfigured",eCouldNotConnect:"LoginError",eServerCertificateRejected:"LoginError",eResponseEmpty:"LoginError",eResponseInvalid:"LoginError",eOperationNotSupported:"OperationNotSupported",eNotUserAuthorized:"NotUserAuthorized"},f=function(a,b){var c="Unknown";e[a]?c=e[a]:d[a]?c=a:b&&e[b]?c=e[b]:b&&d[b]&&(c=b);return d[c]},g={devices:{}},h={registeringPhone:!1,switchingMode:!1,successCb:null,errorCb:null,CUCM:[],password:"",unregisterCb:null},i={},k=function(){var a=!0;try{var c=b.api.getCall}catch(d){a=!1}return a},l=function(a,b,c){try{a._addListener?a._addListener(b,c,!1):document.attachEvent?a.attachEvent("on"+b,c):a.addEventListener(b,c,!1)}catch(d){}},m=function(a,b,c){try{if(a._addListener)return;document.attachEvent?a.detachEvent("on"+b,c):a.removeEventListener(b,c,!1)}catch(d){}},n=function(a){var c=k();c||(j("Plugin has been unloaded. Restarting...."),b=null,a());return c},r={windows:[],windowobjects:[],getWindowId:function(a){var b=a.window,c=this.windowobjects.indexOf(b);c===-1&&!a.readOnly&&(this.windowobjects.push(b),c=this.windowobjects.indexOf(b));return c},add:function(a){if(!!a){a.window||(a.window=window);var c=this.getWindowId({window:a.window});this.windows[c]||(this.windows[c]={});if(typeof a.plugin=="string"){this.windows[c][a.plugin]={windowhandle:null,plugin:null,used:!1};var d=a.window.document.getElementById(a.plugin);d&&d.windowhandle&&this.update({window:a.window,plugin:d})}else a.plugin&&a.plugin.id&&(this.windows[c][a.plugin.id]||(this.windows[c][a.plugin.id]={windowhandle:a.plugin.windowhandle,plugin:a.plugin,used:!1}),a.plugin.windowhandle&&a.plugin.windowhandle!=="00000000"&&!this.windows[c][a.plugin.id].used&&(b.api.addPreviewWindow({windowhandle:a.plugin.windowhandle}),this.windows[c][a.plugin.id].used=!0))}},update:function(a){var c;if(!(!a||!a.plugin||!a.plugin.id)){a.window||(a.window=window);var d=this.getWindowId({window:a.window,readOnly:!0});if(d===-1||!this.windows[d]||!this.windows[d][a.plugin.id])return;a.plugin.windowhandle&&!this.windows[d][a.plugin.id].used&&(this.windows[d][a.plugin.id].windowhandle=a.plugin.windowhandle,b.api.addPreviewWindow({windowhandle:this.windows[d][a.plugin.id].windowhandle}),this.windows[d][a.plugin.id].used=!0)}},remove:function(a){if(!!a){a.window||(a.window=window);var c=this.getWindowId({window:a.window,readOnly:!0});if(c===-1||!this.windows[c])return;typeof a.plugin=="string"&&c>=0&&this.windows[c]&&this.windows[c][a.plugin]&&(this.windows[c][a.plugin].windowhandle&&b.api.removePreviewWindow({windowhandle:this.windows[c][a.plugin].windowhandle}),delete this.windows[c][a.plugin]),a.plugin&&a.plugin.id&&(b.api.removePreviewWindow({windowhandle:a.plugin.windowhandle}),delete this.windows[c][a.plugin.id])}},dump:function(){j("Dumping Preview Windows...");for(var a in this.windows)if(this.windows.hasOwnProperty(a)){j("  window: "+this.windowobjects[a].document.location.pathname);for(var b in this.windows[a])this.windows[a].hasOwnProperty(b)&&j("    ID: "+b+", windowhandle: "+this.windows[a][b].windowhandle+", used: "+this.windows[a][b].used)}}},s={calls:{},windowobjects:[],pendingAdds:[],getWindowId:function(a){var b=a.window,c=this.windowobjects.indexOf(b);c===-1&&!a.readOnly&&(this.windowobjects.push(b),c=this.windowobjects.indexOf(b));return c},checkPendingWindowAdds:function(a,c){windowid=this.getWindowId({window:a}),j("videowindowsbycall.checkPendingWindowAdds() windowid: "+windowid+", videopluginobject.windowhandle: "+c.windowhandle+", videopluginobject.loadid: "+c.loadid);if(this.pendingAdds[windowid]&&this.pendingAdds[windowid][c.loadid]){var d=this.pendingAdds[windowid][c.loadid].callId;b.api.addWindowToCall({callId:d,windowhandle:c.windowhandle}),this.calls[d][windowid][c.loadid].used=!0,delete this.pendingAdds[windowid][c.loadid]}},add:function(a){var c;if(!!a){if(!a.callId)return;a.window||(a.window=window),this.calls[a.callId]||(this.calls[a.callId]=[]),c=this.getWindowId({window:a.window}),this.calls[a.callId][c]||(this.calls[a.callId][c]={});if(typeof a.plugin=="string"){this.calls[a.callId][c][a.plugin]={windowhandle:null,plugin:null,used:!1};var d=a.window.document.getElementById(a.plugin);d&&d.windowhandle&&this.update({window:a.window,callId:a.callId,plugin:d})}else a.plugin&&a.plugin.id&&(this.calls[a.callId][c][a.plugin.id]||(this.calls[a.callId][c][a.plugin.id]={windowhandle:a.plugin.windowhandle,plugin:a.plugin,used:!1}),a.plugin.windowhandle===undefined?(j("adding call id: "+a.callId+" to pending calls, plugin id: "+a.plugin.id+" windowid: "+c),this.pendingAdds[c]||(this.pendingAdds[c]=[]),this.pendingAdds[c][a.plugin.id]||(this.pendingAdds[c][a.plugin.id]={}),this.pendingAdds[c][a.plugin.id]={callId:a.callId}):a.plugin.windowhandle&&a.plugin.windowhandle!=="00000000"&&!this.calls[a.callId][c][a.plugin.id].used&&(j("calling api.addWindowToCall callId: "+a.callId+", windowhandle: "+a.plugin.windowhandle),b.api.addWindowToCall({callId:a.callId,windowhandle:a.plugin.windowhandle}),this.calls[a.callId][c][a.plugin.id].used=!0,this.pendingAdds[c]&&this.pendingAdds[c][a.plugin.id]&&(delete this.pendingAdds[c][a.plugin.id],j("added window to call, removing plugin id: "+a.plugin.id+", windowid: "+c+" from pending calls"))))}},remove:function(a){var c;if(!!a){if(!a.callId)return;if(!this.calls[a.callId])return;a.window||(a.window=window),c=this.getWindowId({window:a.window,readOnly:!0});if(c===-1||!this.calls[a.callId][c])return;typeof a.plugin=="string"&&this.calls[a.callId][c][a.plugin]&&(this.calls[a.callId][c][a.plugin].windowhandle&&b.api.removeWindowFromCall({callId:a.callId,windowhandle:this.calls[a.callId][c][a.plugin].windowhandle}),delete this.calls[a.callId][c][a.plugin]),a.plugin&&a.plugin.id&&(b.api.removeWindowFromCall({callId:a.callId,windowhandle:a.plugin.windowhandle}),delete this.calls[a.callId][c][a.plugin.id])}},update:function(a){var c;if(!(!a||!a.plugin||!a.plugin.id)){a.window||(a.window=window),c=this.getWindowId({window:a.window,readOnly:!0});if(c===-1)return;for(var d in this.calls)this.calls.hasOwnProperty(d)&&this.calls[d][c]&&this.calls[d][c][a.plugin.id]&&a.plugin.windowhandle&&!this.calls[d][c][a.plugin.id].used&&(this.calls[d][c][a.plugin.id].windowhandle=a.plugin.windowhandle,b.api.addWindowToCall({callId:d,windowhandle:this.calls[d][c][a.plugin.id].windowhandle}),this.calls[d][c][a.plugin.id].used=!0)}},deleteCall:function(a){if(a.callId){if(this.calls[a.callId]){for(var c in this.calls[a.callId])if(this.calls[a.callId].hasOwnProperty(c))for(var d in this.calls[a.callId][c])this.calls[a.callId][c].hasOwnProperty(d)&&this.calls[a.callId][c][d].windowhandle&&(b.api.removeWindowFromCall({callId:a.callId,windowhandle:this.calls[a.callId][c][d].windowhandle}),delete this.calls[a.callId][c][d]);delete this.calls[a.callId]}for(var e in this.pendingAdds)if(this.pendingAdds.hasOwnProperty(e))for(var f in this.pendingAdds[e])this.pendingAdds.hasOwnProperty(f)&&this.pendingAdds[e][f].callId==a.callId&&delete this.pendingAdds[e][f]}},dump:function(){j("Dumping Video Windows...");for(var a in this.calls)if(this.calls.hasOwnProperty(a)){j("  callId: "+a);for(var b in this.calls[a])if(this.calls[a].hasOwnProperty(b)){j("    window: "+this.windowobjects[b].document.location.pathname);for(var c in this.calls[a][b])this.calls[a][b].hasOwnProperty(c)&&j("      ID: "+c+", windowhandle: "+this.calls[a][b][c].windowhandle+", used: "+this.calls[a][b][c].used)}}}},t={windowobjects:[],getWindowId:function(a){var b=a.window,c=this.windowobjects.indexOf(b);c===-1&&!a.readOnly&&(this.windowobjects.push(b),c=this.windowobjects.indexOf(b),this.callbacks[c]={});return c},callbacks:[],callCallback:function(a,b){function c(a,b,c){if(a.callbacks[b].hasOwnProperty(c)){var d=a.callbacks[b][c];if(!d.wascalled&&d.callback){try{d.callback(c)}catch(e){j("Exception occurred in application videoLoaded callback",e),typeof console!="undefined"&&console.trace&&console.trace()}d.wascalled=!0}}}var d=this.getWindowId({window:a,readOnly:!0});if(b)c(this,d,b);else for(var e in this.callbacks[d])this.callbacks[d].hasOwnProperty(e)&&c(this,d,e)}};window._cwic_onVideoPluginLoaded=function(a){t.callCallback(window,a.loadid),s.checkPendingWindowAdds(window,a)},window._cwic_onPopupVideoPluginLoaded=function(a,b){try{j("popup _window updated: "+b.document.location.pathname);var c=t.getWindowId({window:b,readOnly:!0});for(var d in t.callbacks[c])if(t.callbacks[c].hasOwnProperty(d)){var e=b.document.getElementById(d);e.windowhandle===a.windowhandle&&(r.update({window:b,plugin:e,windowhandle:a.windowhandle}),s.update({window:b,plugin:e,windowhandle:a.windowhandle}))}}catch(f){}t.callCallback(b,a.loadid)};var y=1,Y={about:o,init:x,shutdown:C,rebootIfBroken:n,registerPhone:I,switchPhoneMode:H,unregisterPhone:J,startConversation:N,updateConversation:P,endConversation:O,createVideoWindow:z,addPreviewWindow:A,removePreviewWindow:B,sendDTMF:Q,getInstanceId:R,getMultimediaDevices:S,setRecordingDevice:T,setPlayoutDevice:U,setCaptureDevice:V,getUserAuthStatus:W,showUserAuthorization:X};a.fn.cwic=function(a){try{if(Y[a])return Y[a].apply(this,Array.prototype.slice.call(arguments,1));if(typeof a=="object"||!a)return Y.init.apply(this,arguments);throw a+": no such method on jQuery.cwic"}catch(b){typeof console!="undefined"&&console.trace&&console.trace(),M(this,b)}}})(jQuery);
